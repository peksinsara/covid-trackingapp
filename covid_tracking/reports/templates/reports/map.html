{% extends "base.html" %} {% block content%}
<div id="map">
  <div class="leaflet-top leaflet-right mt-3 mr-3">
    <input data-target="#reportModal" data-toggle="modal" type="button" id="add-report" value="New Report" onclick=""
      class="btn btn-success" />
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="reportModal" tabindex="-1" role="dialog" aria-labelledby="reportModalLabel"
  aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <strong class="modal-title" id="reportModalLabel">Submit report</strong>

        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>


      <div class="modal-body">
        <form>
          <div class="form-group">
            <label for="id_first_symptomatic">First symptomatic:</label>
            <input type="text" name="first_symptomatic" class="form-control" required="required"
              id="id_first_symptomatic">
          </div>
          <div class="form-group">
            <button type="button" onClick="locateMe()" class="btn btn-info">Locate:</button>
            <label for="id_location_map">Location:</label>
            <input type="hidden" class="form-control" id="id_location" name="location"></input>
            <p class="form-text text-muted" id="status">Test</p>
            <a id = "map-link" target="_blank"></a>
          </div>
          <div id="id_location_map" style="width:100%"></div>
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          Close
        </button>
        <button type="button" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>

{% endblock content%} {% block additional_js %}
<script>
  var map = L.map("map").setView([43.85643, 18.413029], 14);
  var mapLink = ' <a href="https://www.openstreetmap.org">Open Map</a>';

  L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "Map data &copy;" + mapLink,
    maxZoon: 18,
  }).addTo(map);

  jQuery.ajax("/reports/reports_json/", {
    success: function (reports) {
      reports.features.forEach(function (report) {
        L.marker(report.geometry.coordinates).addTo(map);
      });
    },
  });

  var locationMap= L.map('id_location_map').setView([43.85643, 18.413029], 14);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(locationMap);


$('#reportModal').on('shown.bs.modal', function(){ locationMap.invalidateHeight(); })
  function locateMe() {
    const status = document.querySelector('#status');
    const mapLink = document.querySelector('#map-link');

    mapLink.href = '';
    mapLink.textContent = '';

    function success(position) {
      const latitude = position.coords.latitude;
      const longitude = position.coords.longitude;

      latitude_truncated=(latitude).toFixed(4);
      latitude_truncated=(longitude).toFixed(4);

      status.textContent = '';
      mapLink.href = `https://www.openstreetmap.org/#map=18/${latitude_truncated}/${latitude_truncated}`;
      mapLink.textContent = `Latitude: ${latitude_truncated} °, Longitude: ${latitude_truncated} °`;
    }

    function error() {
      status.textContent = 'Unable to retrieve your location';
    }

    if (!navigator.geolocation) {
      status.textContent = 'Geolocation is not supported by your browser';
    } else {
      status.textContent = 'Locating…';
      navigator.geolocation.getCurrentPosition(success, error);
    }

  }

</script>
{% endblock additional_js %} {% block additional_css %}
<style>
  body {
    padding: 0;
    margin: 0;
  }

  html,
  body {
    height: 100%;
    width: 100%;
  }

  #map {
    width: 80%;
    height: 90%;
    margin: auto;
  }

  .btn {
    pointer-events: auto;
  }
  #id_location_map{
    height:300px;
  }
</style>
{% endblock additional_css %}